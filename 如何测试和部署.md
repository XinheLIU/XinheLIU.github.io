# 如何测试和部署Hexo博客

- [如何测试和部署Hexo博客](#如何测试和部署hexo博客)
  - [前置条件](#前置条件)
  - [安装Hexo和依赖](#安装hexo和依赖)
  - [下载和测试Hexo](#下载和测试hexo)
    - [初始化Hexo博客](#初始化hexo博客)
    - [生成和启动服务器](#生成和启动服务器)
    - [访问本地站点](#访问本地站点)
  - [配置渲染Mermaid](#配置渲染mermaid)
  - [配置数学公式渲染](#配置数学公式渲染)
    - [预渲染方案（推荐）](#预渲染方案推荐)
    - [备选方案参考](#备选方案参考)
    - [故障排除](#故障排除)
  - [使用主题美化博客](#使用主题美化博客)
    - [1. 安装matery主题](#1-安装matery主题)
    - [2. 配置主题](#2-配置主题)
    - [3. 创建主题所需页面](#3-创建主题所需页面)
    - [4. 自定义主题配置](#4-自定义主题配置)
    - [5. 预览主题效果](#5-预览主题效果)
  - [使用Git管理博客源文件](#使用git管理博客源文件)
    - [1. 创建分支结构](#1-创建分支结构)
    - [2. 配置.gitignore文件](#2-配置gitignore文件)
    - [3. 初始化源码分支](#3-初始化源码分支)
    - [4. 配置部署设置](#4-配置部署设置)
    - [5. 日常工作流程](#5-日常工作流程)
    - [6. 在其他设备上克隆和工作](#6-在其他设备上克隆和工作)
  - [本地测试](#本地测试)
    - [1. 生成和预览](#1-生成和预览)
    - [2. 访问本地站点](#2-访问本地站点)
    - [3. 开发模式](#3-开发模式)
  - [部署到GitHub Pages](#部署到github-pages)
    - [1. 创建GitHub仓库](#1-创建github仓库)
    - [2. 配置部署设置](#2-配置部署设置)
    - [3. 部署命令](#3-部署命令)
    - [4. 访问线上博客](#4-访问线上博客)
  - [常见问题](#常见问题)
    - [部署认证失败](#部署认证失败)
    - [部署后样式丢失](#部署后样式丢失)
    - [部署后404错误](#部署后404错误)
  - [更新博客](#更新博客)
  - [追踪博客内容的更新](#追踪博客内容的更新)
    - [1. 日常内容更新流程](#1-日常内容更新流程)
      - [1.1 确保在source分支上工作](#11-确保在source分支上工作)
      - [1.2 创建新文章](#12-创建新文章)
      - [1.3 编辑文章内容](#13-编辑文章内容)
      - [1.4 本地预览更改](#14-本地预览更改)
      - [1.5 提交更改到Git](#15-提交更改到git)
      - [1.6 部署到线上](#16-部署到线上)
    - [2. 追踪内容修改历史](#2-追踪内容修改历史)
      - [2.1 查看修改历史](#21-查看修改历史)
      - [2.2 使用GitHub界面查看历史](#22-使用github界面查看历史)
    - [3. 分类和标签管理](#3-分类和标签管理)
    - [4. 多设备同步工作](#4-多设备同步工作)
    - [5. 备份与恢复](#5-备份与恢复)
  - [其他参考](#其他参考)


## 前置条件

在开始之前，请确保已安装：

- Node.js (最低12.0版本)
- Git
- Yarn (替代npm的包管理器)

```bash
brew install node
# check node.js and npm versions
node -v      # eg v18.16.0
npm -v       # eg 9.5.1

npm install -g yarn
# check version
yarn --version

```

## 安装Hexo和依赖

在首次设置时，请执行以下步骤：

```bash
# 全局安装Hexo命令行工具
yarn global add hexo-cli

# 如果无法全局安装 可以选择本地安装Hexo
yarn add hexo hexo-cli

# 安装项目依赖
yarn install

# 安装git部署插件
yarn add hexo server hexo-deployer-git 
```

## 下载和测试Hexo

### 初始化Hexo博客

如果是全新项目或需要重置博客：

```bash
# 使用yarn运行本地安装的hexo命令
yarn hexo init ./hexo-temp

# 将初始化的文件移动到当前目录
cp -r ./hexo-temp/* . 
cp -r ./hexo-temp/.* . 2>/dev/null || true 

# 删除临时目录
rm -rf ./hexo-temp
```

### 生成和启动服务器

使用本地安装的Hexo命令：

```bash
# 清理和生成
yarn hexo clean && yarn hexo generate

# 启动调试服务器
yarn hexo server --debug
```

### 访问本地站点

在浏览器中访问：
```
http://localhost:4000
```

这样你就可以预览重新搭建的博客了。

## 配置渲染Mermaid

文件支持流程图

```bash
yarn remove hexo-renderer-marked
yarn add hexo-renderer-markdown-it hexo-tag-mermaid
```

在config.yml中添加

```
markdown:
  render:
    html: true
    xhtmlOut: false
    breaks: true
    linkify: true
    typographer: true
  plugins:
    - markdown-it-abbr
    - markdown-it-footnote
    - markdown-it-ins
    - markdown-it-sub
    - markdown-it-sup
```

在post文章中填写mermaid语句，需要使用{% mermaid %} 包裹

## 配置数学公式渲染

Hexo支持多种数学公式渲染方案。其中，预渲染方案可以提供最快的性能，不需要在客户端执行JavaScript来渲染公式。

### 预渲染方案（推荐）

这种方法在网站构建时就将数学公式渲染为HTML，加载页面时无需额外的JavaScript渲染过程。

1. 安装hexo-renderer-markdown-it-plus插件：

```bash
yarn remove hexo-renderer-marked
yarn add hexo-renderer-markdown-it-plus
```

2. 在Hexo根目录的`_config.yml`文件中添加配置：

```yaml
markdown_it_plus:
  render:
    html: true
    xhtmlOut: false
    breaks: true
    linkify: true
    typographer: true
  plugins:
    - markdown-it-katex
    - markdown-it-emoji
  anchors:
    level: 2
    permalink: true
    permalinkClass: header-anchor
    permalinkSymbol: ¶
```

3. 使用方式与其他方案相同，直接在Markdown中插入LaTeX语法的公式：

```
行内公式：$E=mc^2$

行间公式：
$$
\frac{\partial u}{\partial t} = h^2 \left( \frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2} + \frac{\partial^2 u}{\partial z^2} \right)
$$
```

4. 无需在文章的front-matter中添加特殊标记，所有文章的数学公式都会被自动渲染。

### 备选方案参考

如果预渲染方案不能满足需求，以下是其他可选方案：

1. **KaTeX客户端渲染**：速度较快，但支持的LaTeX命令较少
2. **MathJax客户端渲染**：功能全面，但速度较慢
3. **hexo-math插件**：支持服务端预渲染与客户端渲染混合模式

### 故障排除

如果公式渲染有问题，请检查：

1. 确保插件正确安装并在`_config.yml`中配置
2. 使用双美元符号`$$`确保行间公式正确显示
3. 如果公式包含特殊字符，可能需要额外的转义
4. 预渲染不支持的高级LaTeX命令可能无法正确显示

无论使用哪种方案，都建议在本地预览时确认公式渲染正确，再部署到线上环境。


## 使用主题美化博客

Hexo提供了丰富的主题选择，本节以hexo-theme-matery为例，介绍如何安装和配置一个美观的博客主题。

### 1. 安装matery主题

```bash
# 克隆matery主题到themes目录
git clone https://github.com/blinkfox/hexo-theme-matery.git themes/matery

# 安装主题所需插件
yarn add hexo-prism-plugin hexo-wordcount
```

### 2. 配置主题

编辑站点配置文件`_config.yml`，修改主题设置：

```yaml
# 将主题修改为matery
theme: matery

# 开启文章资源文件夹
post_asset_folder: true

# 配置代码高亮
syntax_highlighter: prismjs
highlight:
  enable: false
prismjs:
  enable: true
  preprocess: true
  line_number: true
  tab_replace: ''

# 添加Prism插件配置
prism_plugin:
  mode: 'preprocess'
  theme: 'tomorrow'
  line_number: false
```

### 3. 创建主题所需页面

matery主题需要一些特定页面才能正常显示菜单：

```bash
# 创建关于页面
yarn hexo new page "about"

# 创建联系页面
yarn hexo new page "contact"

# 创建友情链接页面
yarn hexo new page "friends"
```

然后编辑这些页面，添加`type`和`layout`字段：

```markdown
---
title: 关于我
date: 2023-01-01
type: "about"
layout: "about"
---

个人介绍内容...
```

### 4. 自定义主题配置

编辑主题配置文件`themes/matery/_config.yml`，可以修改以下内容：

- 导航菜单
- 首页轮播图
- 网站颜色方案
- 社交链接
- 文章特色图
- 页脚信息

### 5. 预览主题效果

```bash
# 清理和生成
yarn hexo clean && yarn hexo generate

# 启动服务器
yarn hexo server
```

访问`http://localhost:4000`查看主题效果。

## 使用Git管理博客源文件

使用Git可以帮助跟踪博客源码的变更历史，并便于在多设备之间同步。针对Hexo博客，推荐使用单仓库双分支的管理方式，即使用同一个仓库的不同分支分别管理源码和部署文件。

### 1. 创建分支结构

在GitHub上创建的`username.github.io`仓库中，使用两个分支：
- `main`分支: 存放生成的静态网站文件，由GitHub Pages自动部署
- `source`分支: 存放Hexo的源文件、配置及主题

### 2. 配置.gitignore文件

创建或修改`.gitignore`文件，排除不需要版本控制的文件：

```
.DS_Store
Thumbs.db
db.json
*.log
node_modules/
public/
.deploy*/
.idea/
.vscode/
*.swp
*.swo
```

### 3. 初始化源码分支

```bash
# 创建并切换到source分支
git checkout -b source

# 添加所有Hexo源文件
git add .

# 如果主题目录包含.git，需要移除
rm -rf themes/主题名/.git

# 提交更改
git commit -m "初始化Hexo源码到source分支"

# 推送到远程仓库
git push -u origin source
```

### 4. 配置部署设置

确保Hexo配置文件`_config.yml`中的部署设置正确指向main分支：

```yaml
deploy:
  type: git
  repo: https://github.com/你的用户名/你的用户名.github.io.git
  branch: main  # 部署到main分支
```

### 5. 日常工作流程

在`source`分支上进行博客内容的编辑和主题调整：

```bash
# 切换到source分支
git checkout source

# 编辑文章、修改配置等...

# 本地预览
yarn hexo clean && yarn hexo server

# 提交更改
git add .
git commit -m "更新博客内容"
git push origin source

# 部署到main分支
yarn hexo clean && yarn hexo deploy
```

### 6. 在其他设备上克隆和工作

在新设备上工作时，只需要克隆`source`分支：

```bash
# 克隆source分支
git clone -b source https://github.com/你的用户名/你的用户名.github.io.git

# 进入目录
cd 你的用户名.github.io

# 安装依赖
yarn install

# 开始工作...
```

这样的分支策略让你能够：
1. 完整保留Hexo博客的源码
2. 在任何设备上轻松还原和继续工作
3. 维护清晰的更改历史
4. 分离内容源码和生成的静态文件

## 本地测试

### 1. 生成和预览

执行以下命令清理、生成和启动本地服务器：

```bash
# 清理之前生成的文件
yarn hexo clean

# 生成静态文件
yarn hexo generate
# 或使用简写
yarn hexo g

# 启动本地服务器
yarn hexo server
# 或使用简写
yarn hexo s
```

也可以使用组合命令：

```bash
yarn hexo clean && yarn hexo g && yarn hexo s
```

### 2. 访问本地站点

启动服务器后，在浏览器中访问：
```
http://localhost:4000
```

这样你就可以在本地预览你的博客了。

### 3. 开发模式

如果你想要在编辑文件时实时刷新预览，可以使用：

```bash
yarn hexo s --debug
```

## 部署到GitHub Pages

### 1. 创建GitHub仓库

首先，你需要创建一个特殊的GitHub仓库，名称为：`你的用户名.github.io`

例如，如果你的GitHub用户名是`example`，那么仓库名应该是`example.github.io`。

### 2. 配置部署设置

在博客根目录的`_config.yml`文件中，确保正确配置了部署信息：

```yaml
deploy:
  type: git
  repo: https://github.com/你的用户名/你的用户名.github.io.git
  branch: main  # 或者使用 master，取决于你的GitHub仓库默认分支
```

### 3. 部署命令

执行以下命令进行部署：

```bash
# 清理之前生成的文件
yarn hexo clean

# 生成静态文件并部署
yarn hexo generate --deploy
# 或使用简写
yarn hexo g -d
# 或
yarn hexo d -g
```

也可以使用组合命令：

```bash
yarn hexo clean && yarn hexo deploy
# 或简写
yarn hexo clean && yarn hexo d
```

### 4. 访问线上博客

部署完成后，等待几分钟，然后访问你的GitHub Pages站点：
```
https://你的用户名.github.io
```

## 常见问题

### 部署认证失败

如果你遇到GitHub认证失败的问题，可能需要配置SSH密钥或使用个人访问令牌。请参考GitHub文档：
- [配置SSH密钥](https://docs.github.com/cn/authentication/connecting-to-github-with-ssh)
- [创建个人访问令牌](https://docs.github.com/cn/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)

### 部署后样式丢失

如果部署后页面样式丢失，请检查`_config.yml`中的`url`和`root`配置是否正确：

```yaml
url: https://你的用户名.github.io
root: /
```

### 部署后404错误

如果遇到404错误，请检查：
1. GitHub Pages是否已启用（在仓库设置中确认）
2. 是否部署到了正确的分支
3. 仓库名称是否正确（应为`你的用户名.github.io`）

## 更新博客

创建新文章：

```bash
yarn hexo new "文章标题"
```

编辑完成后，重复上述部署步骤即可更新你的博客。

## 追踪博客内容的更新

在单仓库双分支结构中（`source`分支存放源码，`main`分支存放生成的静态文件），追踪博客内容更新非常简单且有组织。以下是完整的工作流程：

### 1. 日常内容更新流程

#### 1.1 确保在source分支上工作

```bash
# 查看当前分支
git branch

# 如果不在source分支，切换到source分支
git checkout source
```

#### 1.2 创建新文章

使用Hexo命令创建新文章：

```bash
# 创建一篇名为"我的新文章"的文章
yarn hexo new "我的新文章"
```

这会在`source/_posts/`目录下创建一个名为`我的新文章.md`的文件。

#### 1.3 编辑文章内容

使用Markdown编辑器编辑刚刚创建的文件，添加内容、修改元数据等。

#### 1.4 本地预览更改

```bash
# 启动本地服务器预览更改
yarn hexo clean && yarn hexo server
```

然后在浏览器访问 http://localhost:4000 查看效果。

#### 1.5 提交更改到Git

当你满意文章内容后，将更改提交到Git：

```bash
# 查看变更文件
git status

# 添加更改的文件
git add source/_posts/我的新文章.md

# 提交更改，添加有意义的提交信息
git commit -m "添加新文章：我的新文章"

# 推送到GitHub的source分支
git push origin source
```

#### 1.6 部署到线上

提交更改后，使用Hexo命令部署到`main`分支：

```bash
# 清理、生成并部署
yarn hexo clean && yarn hexo deploy
```

### 2. 追踪内容修改历史

#### 2.1 查看修改历史

你可以使用Git命令查看任何文件的修改历史：

```bash
# 查看某篇文章的修改历史
git log --follow source/_posts/我的新文章.md

# 查看两个版本之间的差异
git diff 旧提交哈希 新提交哈希 source/_posts/我的新文章.md
```

#### 2.2 使用GitHub界面查看历史

1. 登录GitHub
2. 打开你的仓库页面
3. 切换到`source`分支
4. 浏览到具体文件
5. 点击"History"查看该文件的所有历史版本

### 3. 分类和标签管理

使用Hexo的分类和标签功能可以更好地组织你的内容：

```markdown
---
title: 我的新文章
date: 2025-03-14 15:00:00
categories:
  - 技术
tags:
  - Hexo
  - Git
---
```

这样你就可以通过分类和标签页面查找相关文章。

### 4. 多设备同步工作

当你需要在其他设备上继续工作时：

```bash
# 克隆仓库的source分支
git clone -b source https://github.com/你的用户名/你的用户名.github.io.git

# 进入目录
cd 你的用户名.github.io

# 安装依赖
yarn install

# 确保获取最新更改
git pull origin source

# 开始编辑...
```

### 5. 备份与恢复

由于所有内容都由Git管理，你可以随时回到之前的任何版本：

```bash
# 回到特定的提交版本
git checkout 提交哈希值

# 或者回到特定的时间点
git checkout `git rev-list -n 1 --before="2025-03-10 00:00" source`
```

通过这种方式，你的所有内容变更都有记录，并且可以在任何时候恢复到之前的状态，非常适合长期维护博客内容。还有一个好处是，如果你决定更换主题或迁移平台，你的内容仍然是完整保存的。


## 其他参考

-  [Hexo](https://hexo.io/)介绍 [文档](https://hexo.io/docs/) 
   -  [故障排除](https://hexo.io/docs/troubleshooting.html)，[GitHub Issues](https://github.com/hexojs/hexo/issues) 